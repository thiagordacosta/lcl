<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps API Example</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 100vh;
            width: 100%;
        }
        .search-bar-container {
            height: 100vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Search bar section -->
            <div class="col-lg-4 search-bar-container">
                <div class="p-3">
                    <!-- Clear All button -->
                    <p type="button" onclick="clearAll()">Limpar</p>
                    <!-- Autocomplete input field -->
                    <div class="input-group mb-3">
                        <input type="text" id="location-input" class="form-control" placeholder="Entre a origem do seu envio LCL">
                        <button class="btn btn-primary" type="button" onclick="searchLocation()">Buscar</button>
                    </div>
                    <!-- Cards section -->
                    <div id="cards"></div>
                </div>
            </div>

            <!-- Map section -->
            <div class="col-lg-8">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        var map;
        var markers = [];
        var persistentLine = null;  // Persistent line variable

        // Mock data for supplier prices
        var supplierPrices = [
            { name: 'Supplier 1', price: 1000 },
            { name: 'Supplier 2', price: 1100 },
            { name: 'Supplier 3', price: 1050 },
            { name: 'Supplier 4', price: 1200 },
            { name: 'Supplier 5', price: 950 },
            { name: 'Supplier 6', price: 1020 },
            { name: 'Supplier 7', price: 1250 },
            { name: 'Supplier 8', price: 1080 },
            { name: 'Supplier 9', price: 1150 },
            { name: 'Supplier 10', price: 1125 }
        ];

        // Initialize and display the map
        function initMap() {
            // Initialize the map with a center covering the entire world
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 2, // Adjust the zoom level to fit the entire world
                center: { lat: 0, lng: 0 } // Center of the world
            });

            // Initialize the autocomplete object
            var autocomplete = new google.maps.places.Autocomplete(
                document.getElementById('location-input'));

            // Set the bounds to restrict autocomplete results to a specific area (optional)
            autocomplete.bindTo('bounds', map);

            // Function to handle place selection from autocomplete
            autocomplete.addListener('place_changed', function() {
                var place = autocomplete.getPlace();
                if (!place.geometry) {
                    window.alert("No details available for input: '" + place.name + "'");
                    return;
                }

                // Ensure the location is only in Shenzhen
                var shenzhenBounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(22.375, 113.775),
                    new google.maps.LatLng(23.375, 114.775)
                );
                if (!shenzhenBounds.contains(place.geometry.location)) {
                    window.alert("Por favor informe Shenzhen como origem.");
                    return;
                }

                // If the place has a geometry, display it on the map
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17); // Default zoom level when no viewport is available
                }

                // Clear previous markers and lines
                clearMarkers();
                clearLines();

                // Set the marker position for the searched location
                addMarker(place.geometry.location, "Search Result: " + place.name, '#FF0000'); // Change marker color for search result

                // Add additional markers
                addLocationMarkers(place.geometry.location);

                // Display supplier prices
                displaySupplierPrices();

                // Adjust map bounds to include all markers
                var bounds = new google.maps.LatLngBounds();
                markers.forEach(function(marker) {
                    bounds.extend(marker.getPosition());
                });
                map.fitBounds(bounds);
            });
        }

        // Function to add a marker to the map
        function addMarker(location, name, color) {
            var marker = new google.maps.Marker({
                position: location,
                map: map,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    fillColor: color,
                    fillOpacity: 1,
                    strokeWeight: 0,
                    scale: 8
                }
            });
            markers.push(marker);

            var infowindow = new google.maps.InfoWindow({
                content: name
            });

            marker.addListener('mouseover', function() {
                infowindow.open(map, marker);
            });

            marker.addListener('mouseout', function() {
                infowindow.close();
            });
        }

        // Function to add location markers based on search result
        function addLocationMarkers(searchLocation) {
            var lowestPriceSupplier = supplierPrices.reduce((lowest, supplier) => 
                supplier.price < lowest.price ? supplier : lowest, supplierPrices[0]);

            var locations = [
                { name: 'Porto de Santos', location: { lat: -23.958056, lng: -46.303889 }, lowestPrice: lowestPriceSupplier.price, supplierName: lowestPriceSupplier.name },
                // Add other locations if needed
            ];

            var logoUrl = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRVe_2Y2KKHo7iNmDu2DDb1XEKEpp1fKk8vnQ&s";

            locations.forEach(function(location) {
                var contentString = `
                    <div>
                        <h5>${location.name}</h5>
                        <p>Supplier: ${location.supplierName}</p>
                        <p>Lowest Price: $${location.lowestPrice} Ton/M3</p>
                        <img src="${logoUrl}" alt="Shipping Company Logo" style="max-width: 100px;">
                    </div>`;

                var infowindow = new google.maps.InfoWindow({
                    content: contentString
                });

                var marker = new google.maps.Marker({
                    position: location.location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#4285F4',
                        fillOpacity: 1,
                        strokeWeight: 0,
                        scale: 8
                    }
                });

                markers.push(marker);

                // Add click event to show persistent line
                marker.addListener('click', function() {
                    if (persistentLine) {
                        persistentLine.setMap(null); // Clear the previous persistent line
                    }

                    persistentLine = new google.maps.Polyline({
                        path: [searchLocation, marker.getPosition()],
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1,  // Persistent line visible
                        strokeWeight: 2,
                        map: map
                    });

                    infowindow.open(map, marker); // Show the infowindow on click
                });

                marker.addListener('mouseover', function() {
                    infowindow.open(map, marker);
                });

                marker.addListener('mouseout', function() {
                    infowindow.close();
                });
            });
        }

        // Function to clear all markers from the map
        function clearMarkers() {
            markers.forEach(function(marker) {
                marker.setMap(null);
            });
            markers = [];
        }

        // Function to clear all lines from the map
        function clearLines() {
            if (persistentLine) {
                persistentLine.setMap(null);  // Clear persistent line
                persistentLine = null;
            }
        }

        // Function to display supplier prices
        function displaySupplierPrices() {
            var cardsContainer = document.getElementById('cards');
            cardsContainer.innerHTML = ''; // Clear previous cards

            // Iterate over supplier prices and create cards
            supplierPrices.forEach(function(supplier) {
                var card = document.createElement('div');
                card.classList.add('card', 'mb-3');
                card.innerHTML = '<div class="card-body" onclick="displayCardInformation(\'' + supplier.name + '\', ' + supplier.price + ')"><h5 class="card-title">' + supplier.name + '</h5><p class="card-text">Price: $' + supplier.price + ' Ton/M3</p></div>';
                cardsContainer.appendChild(card);
            });
        }

        // Function to search for a location
        window.searchLocation = function() {
            var input = document.getElementById('location-input').value;

            // Use the Geocoding API to convert the location into coordinates
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: input }, function(results, status) {
                if (status === 'OK') {
                    var location = results[0].geometry.location;

                    // Ensure the location is only in Shenzhen
                    var shenzhenBounds = new google.maps.LatLngBounds(
                        new google.maps.LatLng(22.375, 113.775),
                        new google.maps.LatLng(23.375, 114.775)
                    );
                    if (!shenzhenBounds.contains(location)) {
                        window.alert("Por favor informe Shenzhen como origem.");
                        return;
                    }

                    map.setCenter(location);

                    // Clear previous markers and lines
                    clearMarkers();
                    clearLines();

                    // Set the marker position for the searched location
                    addMarker(location, "Search Result: " + input, '#FF0000'); // Change marker color for search result

                    // Add additional markers
                    addLocationMarkers(location);

                    // Display supplier prices
                    displaySupplierPrices();

                    // Adjust map bounds to include all markers
                    var bounds = new google.maps.LatLngBounds();
                    markers.forEach(function(marker) {
                        bounds.extend(marker.getPosition());
                    });
                    map.fitBounds(bounds);
                } else {
                    alert('Geocode was not successful for the following reason: ' + status);
                }
            });
        };

        // Function to clear the search result
        function clearAll() {
            document.getElementById('location-input').value = '';
            clearMarkers();
            clearLines();
            clearSupplierPrices();
            map.setCenter({ lat: 0, lng: 0 });
            map.setZoom(2);
        }

        // Function to clear the supplier prices cards
        function clearSupplierPrices() {
            var cardsContainer = document.getElementById('cards');
            cardsContainer.innerHTML = '';
        }
    </script>
    <!-- Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMV14guM5kbAvhtNhCy12zhblH1QF5V-0&libraries=places&callback=initMap" async defer></script>
</body>
</html>
